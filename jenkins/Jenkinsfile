pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        ECR_REPO = '576607007321.dkr.ecr.us-east-1.amazonaws.com/gitops-gp-ecr'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }

    stages {

        stage('Clone NodeJS App Repo') {
            steps {
                echo "üîÑ Cloning NodeJS application repository..."
                sh '''
                git clone https://github.com/mahmoud254/jenkins_nodejs_example.git
                mv jenkins_nodejs_example nodejs-app
                '''
                echo "‚úÖ Repository cloned successfully"
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "üî® Building Docker image..."
                script {
                    sh 'docker build -t $ECR_REPO:$IMAGE_TAG ../nodejs-app'
                }
                echo "‚úÖ Docker image built: $ECR_REPO:$IMAGE_TAG"
            }
        }

        stage('Login to ECR') {
            steps {
                echo "üîê Logging in to Amazon ECR..."
                script {
                    // IRSA provides AWS creds automatically, so no explicit credentials needed
                    sh '''
                    aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REPO
                    '''
                }
                echo "‚úÖ ECR login successful"
            }
        }

        stage('Push Docker Image to ECR') {
            steps {
                echo "Pushing Docker image to ECR..."
                script {
                    sh 'docker push $ECR_REPO:$IMAGE_TAG'
                }
                echo "‚úÖ Image pushed to ECR: $ECR_REPO:$IMAGE_TAG"
            }
        }
    }
    post {
        failure {
            echo "‚ùå Pipeline failed. Check above logs for details."
        }
        success {
            echo "üéâ Pipeline completed successfully!"
        }
    }
}


